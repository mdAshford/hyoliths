---
title: "Visualizing characters"
author: "Martin R. Smith"
date: "`r Sys.Date()`"
bibliography: [References.bib, MorphoBank.bib]
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-old-doi-prefix.csl
output:
  html_document: default
  pdf_document: default
---

# Character reconstructions {#reconstructions}

```{R, echo=FALSE}
library('Inapp')
tree <- iw.trees[[3]][[1]]
tree$edge.length <- rep(1, nrow(tree$edge))

ReadNotes <- function (filepath) {
  lines <- readLines(filepath)
  charNote.pattern <- "^\\s+TEXT\\s+CHARACTER=(\\d+)\\s+TEXT='(.*)';\\s*$"
  stateNote.pattern <- "^\\s+TEXT\\s+TAXON=(\\d+)\\s+CHARACTER=(\\d+)\\s+TEXT='(.*)';\\s*$"
  upperLines <- toupper(lines)
  notesStart <- which(upperLines == "BEGIN NOTES;")
  endBlocks <- which(upperLines == "ENDBLOCK;")
  if (length(notesStart) == 0) {
    return(list("NOTES block not found in Nexus file."))
  } else if (length(notesStart) > 1) {
    return(list("Multiple NOTES blocks found in Nexus file."))
  } else {
    notesEnd <- endBlocks[endBlocks > notesStart][1] - 1L
    notesLines <- lines[(notesStart + 1):notesEnd]
    charNote.matches <- grepl(charNote.pattern, notesLines, perl=TRUE)
    charNotes <- gsub(charNote.pattern, "\\2",
                       notesLines[charNote.matches], perl=TRUE)
    charNotes <- gsub("^n", "  \n", charNotes, fixed=TRUE)
    charNotes <- gsub("''", "'", charNotes, fixed=TRUE)
    charNumbers <- gsub(charNote.pattern, "\\1",
                              notesLines[charNote.matches], perl=TRUE)
    
    stateNote.matches <- grepl(stateNote.pattern, notesLines, perl=TRUE)
    stateNotes <- gsub(stateNote.pattern, "\\3",
                       notesLines[stateNote.matches], perl=TRUE)
    stateNotes <- gsub("^n", "  \n", stateNotes, fixed=TRUE)
    stateTaxon <- gsub(stateNote.pattern, "\\1",
                              notesLines[stateNote.matches], perl=TRUE)
    stateChar  <- gsub(stateNote.pattern, "\\2",
                              notesLines[stateNote.matches], perl=TRUE)
    
    charNotes <- lapply(seq_len(max(c(stateChar, charNumbers))), function (i) {
      ret <- list(
        charNotes[charNumbers == i],
        stateNotes[stateChar == i])
      names(ret[[2]]) <- stateTaxon[stateChar == i]
      
      # Return:
      ret
    })
    names(charNotes) <- charNumbers
    
    # Return:
    charNotes
  }
}

PrintStates <- function (states) {
  tokens <- seq_along(states) - 1L
  if (states[1] == "''") {
    states <- states[-1]
    tokens <- tokens[-1]
    transformational <- TRUE
  } else {
    transformational <- FALSE
  }
  cat(paste0(" > ", tokens, ": ", states, "  \n"))
  cat("> ", if (transformational) "Transformational" else "Neomorphic", " character.  \n>\n")
}

char_names <- gsub("^'(.+)'$", "\\1", colnames(my_chars))
char_notes <- ReadNotes(filename)
taxa_names <- c("Namacalathus", rownames(my_chars))
taxa_plaintext <- gsub("_", " ", taxa_names, fixed=TRUE)
taxa_italic <- paste0("_", taxa_plaintext, "_")
Italicize <- function (text) {
  gsub(paste0("\\b(", paste0(gsub("_", "|", c(taxa_names, 'et al\\.', 'et al'), fixed = TRUE), collapse='|'),
              ")\\b"), "_\\1_", text, perl=TRUE, ignore.case=TRUE)
}
#treeCol <- tipCol[tree$tip.label]
```

This page defines each characer and accounts for its coding in particular taxa.  Citations for all codings can be found by browsing the [morphological dataset](#dataset) on MorphoBank ([project 2800](https://morphobank.org/permalink/?P2800)).

The _Inapp_ _R_ package [@Brazeau2018] was used to map each character onto one of the most parsimonious trees (obtained under implied weighting, $k = 4.5$):


```{R, echo=FALSE, fig.height=6.6, fig.width=7.1, results="asis"}
for (i in seq_len(ncol(my_chars))) {
  cat("\n## ", char_names[i], " {-}  \n")
  
  par(mar=rep(0.2, 4), cex=0.7)
  
  plot.states.matrix(apply.reconstruction(tree, my_chars[, i]),
                     passes=0, counts=1:2, show.labels=1,
                     col.states=TRUE, state.labels=my_states[[i]],
                     #tip.col=treeCol, 
                     use.edge.length=TRUE, legend.pos='topright')
  
  cat("  \n\n **Character ", i, ": ", char_names[i], "**  \n\n")
  PrintStates(my_states[[i]])
  cat("  \n\n")
  char_notes_i <- char_notes[[i]]
  state_notes_i <- char_notes_i[[2]]
  if (length(char_notes_i[[1]]) > 0) cat(Italicize(char_notes_i[[1]]), "  \n")
  if (length(state_notes_i) > 0) {
    cat("  \n ", paste0(taxa_italic[as.integer(names(state_notes_i))],
                      ": ", Italicize(state_notes_i), "  \n  \n "))
  }
  cat("  \n") # Clear line, ready for next block
}
```


```{R Morphobank bibliography, echo=FALSE}
mbBib <- list.files(pattern='morphobank_bibliography.*\\.txt', full.names=TRUE)
mbRecent <- mbBib[which.max(file.mtime(mbBib))]
refs <- as.matrix(read.delim(mbRecent, sep="\t", header=TRUE, skip=1, row.names=NULL))
FirstWord <- function (text) gsub("^(\\w+).*$", "\\1", trimws(text), perl=TRUE)
FirstWords <- function (text) gsub("^\\W*(\\w+)\\W*(\\w+)?.*", "\\1\\2", trimws(text), perl=TRUE)
FormatAuthors <- function (text) {
  authors <- trimws(strsplit(text, ';')[[1]])
  names.pattern <- "(\\w+,)\\s(.*)"
  surnames <-  gsub(names.pattern, "\\1 ", authors)
  forenames <- gsub(names.pattern, "\\2", authors)
  forenames <- gsub("(\\w)\\w+\\.?", "\\1.", forenames)
  forenames <- gsub("\\.(\\w)", ". \\1", forenames)
  
  # Return:
  paste0(surnames, forenames, collapse=' and ')
}
RefKey <- function (ref) paste0(FirstWord(ref['Author']),
                                trimws(ref['Year']),
                                FirstWords(ref['Title']))
BibEntry <- function (ref) {
  BibLine <- function (bibKey, key, text=ref[key]) {
    if (is.na(ref[key]) || ref[key] == "") "" else  paste0("  ", bibKey, " = {", trimws(text), "},\n")
  }
  refType <- tolower(FirstWord(ref['Reference.Type']))
  if (refType %in% c('generic', 'journal')) refType <- 'article'
  paste0("@", refType, '{', 
         RefKey(ref), ",\n",
         BibLine('author', 'Author', FormatAuthors(ref['Author'])),
         BibLine('doi', 'DOI'),
         BibLine('journal', 'Secondary.Title'),
         BibLine('title', 'Title', paste0('{', gsub("</?i>", "_", ref["Title"], perl=TRUE), '}')),
         BibLine('number', 'Number'),
         BibLine('pages', 'Pages', gsub("\\-+", "--", ref["Pages"], perl=TRUE)),
         BibLine('volume', "Volume"),
         BibLine('year', 'Year'),
         "}\n"
         )
}

bibFile <- file("MorphoBank.bib", encoding='UTF-8')
writeLines(apply(refs, 1, BibEntry), bibFile)
close(bibFile)
```

## Literature cited in character exposition {-}

```{R Character references from MorphoBank, echo=FALSE, results='asis'}
cat(paste0('[@', paste0(apply(refs, 1, RefKey), collapse=';@'), ']'))
```
